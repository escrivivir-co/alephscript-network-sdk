# =============================================================================
# OASIS Docker Compose - Configuraci√≥n Limpia Integrada
# Versi√≥n unificada que integra todos los scripts nativos
# =============================================================================
# Componentes:
#   - oasis-dev: Red social descentralizada SSB
#   - ecoin-wallet: Wallet cryptocurrency P2P ECOin
# =============================================================================

services:
  # ===========================================================================
  # OASIS - Red Social Descentralizada
  # ===========================================================================
  oasis-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: oasis-server-dev
    ports:
      - "8008:8008"   # Puerto SSB
      - "3000:3000"   # Puerto cliente web
    volumes:
      # Volumenes persistentes para datos cr√≠ticos
      - oasis-ssb-data-dev:/home/oasis/.ssb
      - oasis-ai-models-dev:/app/src/AI/models
      - oasis-logs-dev:/app/logs   

    environment:
      - NODE_ENV=production
      # üîß DEFINITIVO: Prohibir compilaci√≥n completamente
      - NODE_LLAMA_CPP_SKIP_DOWNLOAD=false
      - NODE_LLAMA_CPP_USE_PREBUILT_BINARIES=true
      - NODE_LLAMA_CPP_BUILD_FROM_SOURCE=false
      - NODE_LLAMA_CPP_FORCE_BUILD=never
      - NODE_LLAMA_CPP_SKIP_LLAMA_CPP_CLONE=true
      # GPU Configuration 
      - GPU_ENABLED=true
      - GPU_LAYERS=35
      - VRAM_PADDING=256
      # NVIDIA GPU Configuration
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      # ECOin Wallet Integration (comunicaci√≥n via docker network)
      - ECOIN_RPC_URL=http://ecoin-wallet:7474
      - ECOIN_RPC_USER=ecoinrpc
      - ECOIN_RPC_PASS=ecoinrpc
    
    # ‚úÖ GPU habilitada con runtime nvidia y configuraci√≥n dual
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - oasis-network
    # Opcional: esperar a que ECOin est√© listo
    # depends_on:
    #   ecoin-wallet:
    #     condition: service_healthy

  # ===========================================================================
  # ECOIN WALLET - Cryptocurrency P2P
  # ===========================================================================
  ecoin-wallet:
    build:
      context: ./ECOIN_DOCKERIZE
      dockerfile: Dockerfile
    container_name: ecoin-wallet
    ports:
      - "7474:7474"     # RPC JSON-RPC (comunicaci√≥n con Oasis + debug)
      - "12000:12000"   # P2P ECOin network
    volumes:
      - ecoin-data-dev:/home/ecoin/.ecoin
    environment:
      - RPC_USER=ecoinrpc
      - RPC_PASS=ecoinrpc
      - RPC_PORT=7474
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf --user ecoinrpc:ecoinrpc --data-binary '{\"jsonrpc\":\"1.0\",\"id\":\"health\",\"method\":\"getinfo\",\"params\":[]}' -H 'content-type: text/plain;' http://127.0.0.1:7474/ || exit 1"]
      interval: 60s
      timeout: 15s
      retries: 5
      start_period: 180s  # Blockchain sync puede tardar
    networks:
      - oasis-network

# Volumenes persistentes nombrados
volumes:
  oasis-ssb-data-dev:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes-dev/ssb-data
  
  oasis-ai-models-dev:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes-dev/ai-models
  
  oasis-logs-dev:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes-dev/logs

  # ECOin wallet data (wallet.dat, blockchain, etc.)
  ecoin-data-dev:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes-dev/ecoin-data

# Red compartida para comunicaci√≥n Oasis <-> ECOin
networks:
  oasis-network:
    name: oasis-network-dev
    driver: bridge